{% extends "base.html" %}

{% block cabecalho %}
    <!-- CSS do Leaflet e Leaflet Draw -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
{% endblock %}

{% block conteudo %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white text-center">
                    <h4>Cadastrar Nova Obra</h4>
                </div>
                <div class="card-body p-4">
                    <form method="post" action="{% url 'cadastra_obra' 0 %}">
                        {% csrf_token %}

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_situacao" class="form-label">Situação</label>
                                {{ form.situacao }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="id_contrato" class="form-label">Contrato Vinculado</label>
                                {{ form.contrato }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="id_nome" class="form-label">Nome da Obra</label>
                            {{ form.nome }}
                            {% if form.nome.errors %}
                                <div class="text-danger small">
                                    {{ form.nome.errors }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="id_local" class="form-label">Local</label>
                            {{ form.local }}
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_inicio" class="form-label">Data de Início</label>
                                {{ form.inicio }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="id_termino" class="form-label">Previsão de Término</label>
                                {{ form.termino }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="id_empresa_responsavel" class="form-label">Empresa Responsável</label>
                            {{ form.empresa_responsavel }}
                        </div>

                        <!-- Campo do mapa -->
                        <div class="mb-4">
                            <h5 class="mt-4">Área da Obra</h5>
                            <p class="text-muted small">Desenhe no mapa o limite da obra:</p>
                            <div id="map" style="height: 500px;"></div>
                            <input type="hidden" id="id_area" name="area" />
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{% url 'controle_obras' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Voltar
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle"></i> Salvar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts do Leaflet e Leaflet Draw (somente uma vez, no final da página para performance) -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const map = L.map("map").setView([-16.6786, -49.2539], 13); //cordenadas centro de Goiânia

    // Tile gratuito do OpenStreetMap
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
        draw: {
            polygon: true,
            polyline: false,
            rectangle: false,
            circle: false,
            marker: false,
            circlemarker: false
        },
        edit: {
            featureGroup: drawnItems
        }
    });
    map.addControl(drawControl);

    // Quando desenhar uma nova área
    map.on(L.Draw.Event.CREATED, e => {
        drawnItems.clearLayers(); // remove anterior
        const layer = e.layer;
        drawnItems.addLayer(layer);

        const geojson = layer.toGeoJSON();
        document.getElementById("id_area").value = JSON.stringify(geojson.geometry);
        
    });

    // Quando editar uma área existente
    map.on(L.Draw.Event.EDITED, () => {
        const layer = drawnItems.getLayers()[0];
        if (layer) {
            const geojson = layer.toGeoJSON();
            document.getElementById("id_area").value = JSON.stringify(geojson.geometry);
        }
    });
});
</script>
{% endblock %}
